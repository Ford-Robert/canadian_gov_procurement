---
title: "Procurements of the Canadian Government, Runaway Military Contracts"
author: 
  - Robert Ford
thanks: "Code and data are available at: https://github.com/Ford-Robert"
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(ggplot2)
library(dplyr)
library(lubridate)
library(scales)
library(knitr)
library(kableExtra)
library(zoo)

df <- read_csv(here::here("data/analysis_data/cleaned_data.csv"))
aggregated_df <- (here::here("data/analysis_data/top_ten_suppliers.csv"))
models <- read_csv(here::here("models/buyer_models.rds"))
```


# Introduction

TODO Broader context of Canadian spending, talk about huge new military spending package announced this year

TODO What are procurement, how are they awarded, what are Buyers and Suppliers

TODO Gap that needs to be filled; What is the Government buying from private companies and how is their consumption changing over time

TODO What was done

TODO What was found

TODO Why is it important

TODO Paper layout, description of each section with jump links

TODO Cite R and all other packages

Estimand?

# Data {#sec-data}

TODO Description of each variable head of table

```{r fig-head}
#| message: false
#| echo: false
#| warning: false
#| fig-cap: template
#| fig-align: center

df_table <- df %>% select(-contract, -start_date, -end_date)

kable(head(df_table, 5), caption = "Sample of the Data") %>%
  kable_styling(font_size = 10, latex_options = c("scale_down"))

```

TODO Brief talk about how cleaning was carried out

TODO Description of variables that were created, duration_days, processed_supplier (brief, see appendix)

## Shape

TODO Talk about top 5 buyers and other

```{r fig-top-buyers}
#| message: false
#| echo: false
#| warning: false
#| fig-cap: template
#| fig-align: center

#TODO color each buyer with the correct color

# Summarize total amount spent by each buyer
buyer_totals <- df %>%
  group_by(buyer) %>%
  summarise(total_amount = sum(amount, na.rm = TRUE)) %>%
  arrange(desc(total_amount))

# Identify the top 5 buyers
top_five_buyers <- buyer_totals %>%
  slice_head(n = 5) %>%
  pull(buyer)

# Create a new column 'buyer_group' where buyers not in top 5 are labeled as 'Other'
buyer_totals_grouped <- buyer_totals %>%
  mutate(buyer_group = ifelse(buyer %in% top_five_buyers, buyer, "Other")) %>%
  group_by(buyer_group) %>%
  summarise(total_amount = sum(total_amount, na.rm = TRUE)) %>%
  arrange(desc(total_amount))

# Plot the bar chart
ggplot(buyer_totals_grouped, aes(x = reorder(buyer_group, total_amount), y = total_amount)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  coord_flip() +
  labs(title = "Top 5 Buyers by Total Amount Spent and Others",
       x = "Buyer",
       y = "Total Amount Spent (CAD)") +
  scale_y_continuous(labels = comma) +
  theme_minimal()

```


TODO Top Ten Suppliers

```{r fig-top-supps}
#| message: false
#| echo: false
#| warning: false
#| fig-cap: template
#| fig-align: center

aggregated_df <- aggregated_df %>%
  left_join(top_ten %>% select(word, supplier_name), by = "word")

# Create the bar chart with legend removed
ggplot(aggregated_df, aes(x = reorder(word, total_amount), y = total_amount, fill = buyer)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(
    title = "Top 10 Suppliers by Aggregated Amount Awarded",
    x = "Supplier",
    y = "Total Amount Awarded"
    # Remove the legend title by not specifying 'fill' in labs
  ) +
  theme_minimal() +
  theme(legend.position = "none")

# 10. Transform `processed_supplier` into a Character Column for CSV
df <- df %>%
  mutate(
    processed_supplier = sapply(processed_supplier, function(x) {
      if(length(x) > 0) {
        paste(x, collapse = " ")
      } else {
        ""  # Represent empty lists as empty strings
      }
    })
  )
```

TODO Military Spending Per year
```{r fig-mil-spending}
#| message: false
#| echo: false
#| warning: false
#| fig-cap: template
#| fig-align: center

#TODO Make right color

df_filtered <- df %>%
  filter(format(award_date, "%Y") != "2019")

# Convert award_date to Date type and extract the year
df_filtered$award_date <- as.Date(df_filtered$award_date, format = "%Y-%m-%d")
df_filtered$year <- format(df_filtered$award_date, "%Y")

# Filter for military spending (where buyer is "National Defence")
military_df <- df_filtered %>%
  filter(buyer == "National Defence")

# Summarize total spending per year
military_spending_per_year <- military_df %>%
  group_by(year) %>%
  summarize(total_spending = sum(amount, na.rm = TRUE))

# Create the bar chart
ggplot(data = military_spending_per_year, aes(x = year, y = total_spending)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Military Spending Per Year", x = "Year", y = "Total Spending") +
  theme_minimal() +
  scale_y_continuous(labels = dollar_format(prefix = "$")) +
  theme(plot.title = element_text(hjust = 0.5))

```



TODO Public Services Spending
```{r fig-public-spending}
#| message: false
#| echo: false
#| warning: false
#| fig-cap: template
#| fig-align: center

#TODO Make right color

df_filtered <- df %>%
  filter(format(award_date, "%Y") != "2019")

df_filtered$year <- format(df_filtered$award_date, "%Y")

# Filter for military spending (where buyer is "National Defence")
public_services_df <- df_filtered %>%
  filter(buyer == "Public Services and Procurement Canada")

# Summarize total spending per year
public_spending_per_year <- public_services_df %>%
  group_by(year) %>%
  summarize(total_spending = sum(amount, na.rm = TRUE))

# Create the bar chart
ggplot(data = public_spending_per_year, aes(x = year, y = total_spending)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Public Services Spending Per Year", x = "Year", y = "Total Spending") +
  theme_minimal() +
  scale_y_continuous(labels = dollar_format(prefix = "$")) +
  theme(plot.title = element_text(hjust = 0.5))


```




## Measurement

TODO How IJF collected all this data






# Model

TODO What the is the goal of our models

Here we briefly describe the Bayesian analysis model used to investigate... Background details and diagnostics are included in [Appendix -@sec-model-details].

## Model set-up

TODO define variables used and structure

TODO Cite R and packages used to run model


### Model justification

TODO Why I chose those variables


# Results

TODO Add model summary tables




# Discussion

## First discussion point {#sec-first-point}


## Second discussion point


## Third discussion point


## Weaknesses and next steps



\newpage

\appendix

# Appendix {-}


# Additional data details

TODO Removal of negative values, adding 1 day to contract lengths of 0, see cleaning script

TODO processed_supplier

# Model details {#sec-model-details}

## Posterior predictive check

## Diagnostics


\newpage


# References


